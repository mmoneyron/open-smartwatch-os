
#include "./apps/main/histogram.h"

#include "gfx_util.h"
#include "osw_app.h"
#include "osw_hal.h"
#include "osw_ui_util.h"
#include "config.h"

bool steps_icon[784] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,
                        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,
                        0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,
                        0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,
                        0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,
                        1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,
                        1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,
                        1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,
                        1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,
                        1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,
                        1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,0,
                        1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,0,
                        1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,
                        0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,
                        0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,
                        0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,
                        0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,
                        0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                        0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
                        0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,
                        0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,
                        0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,
                        0,1,1,1,1,1,1,1,1,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,
                        0,1,1,1,1,1,1,1,1,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,
                        0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,
                        0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                        0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
                        0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,};

void drawStepsIcon(OswHal* hal, uint16_t x, uint16_t y) {
  for (int i = 0; i < 28; i++) {
    for (int j = 0; j < 28; j++) {
      if (steps_icon[j*28 + i]) {
        hal->getCanvas()->getGraphics2D()->drawPixel(x+i, y+j, rgb565(255, 255, 255));
      }
    }
  }
}

void OswAppHistogram::setup(OswHal* hal) {
  // hal->enableDisplayBuffer();
}

void OswAppHistogram::loop(OswHal* hal) {

  hal->getCanvas()->fillScreen(0);
  hal->getCanvas()->setTextColor(rgb565(255, 255, 255));
  char days[7] = {'M', 'T', 'W', 'T', 'F', 'S', 'S'};
  uint16_t color;

  uint16_t steps_history[7];
  hal->getWeekSteps(steps_history);
  
  hal->getCanvas()->getGraphics2D()->drawHLine(10, 165, 220, rgb565(127, 127, 127));
  hal->getCanvas()->getGraphics2D()->drawHLine(10, 166, 220, rgb565(127, 127, 127));

  hal->getCanvas()->setTextSize(2);
  for (int i = 0; i < 7; i++) {
    if (steps_history[i]) {
      if (steps_history[i] >= STEPS_GOAL) {
        color = rgb565(0xe8, 0xb7, 0x00);
      } else {
        color = rgb565(255, 255, 255);
      }
      hal->getCanvas()->getGraphics2D()->drawThickLine(29+i*30, 155-(steps_history[i]*100/STEPS_GOAL), 29+i*30, 155, 7, color);
      
    }
    hal->getCanvas()->setCursor(25+i*30, 170);
    hal->getCanvas()->print(days[i]);
  }


  hal->getCanvas()->setTextSize(3);
  hal->getCanvas()->setCursor(80, 200);
  hal->getCanvas()->print(steps_history[hal->getDayOfWeek()]);
  drawStepsIcon(hal, 150, 195);

  hal->requestFlush();
}

void OswAppHistogram::stop(OswHal* hal) {
  // hal->disableDisplayBuffer();
}
